---
title: "Final Project"
output:
  html_document:
    df_print: paged
  html_notebook: default
  word_document: default
---
```{r libraries, warning=FALSE, include=FALSE}
#load needed libraries
library(tidyverse)
library(lubridate)
library(gridExtra) 
library(modeest)
library(knitr)
library(kableExtra)
library(latticeExtra)
library(arules)
library(arulesViz)
```
```{r, include=FALSE}
#Setting wd and loading data
#put the path of where you are storing the data on your computer
paths = c('C:/Users/eliza/Documents/BANA 7047 - Data Mining II/Group Project/Data', 'C:/Users/ashle/Downloads/8451_The_Complete_Journey_2_Master (1)/The_Complete_Journey_2_Master', 'C:/Users/xiaoj/Desktop/BANA/BANA7047 Data Mining II/Project/8451_The_Complete_Journey_2_Master/The_Complete_Journey_2_Master')
#use the code Sys.info()[7] to find out how your name is stored on your local machine, copy to this list
names(paths) = c('eliza', 'ashle', 'xiaoj')
#this will set the wd
setwd(paths[Sys.info()[7]])

load(file = "organic_households.Rdata")
load(file = "market_basket.Rdata")
load(file = "household_increase.Rdata")
```
# Introduction

Understanding what drives customers to buy organic products is key as in many segments the market growth of organic products is outstripping that of the overall segment. Organic products also represent billions of dollars in sales and the availability of orgnic products is a key factor in why some consumers pick one grocery store over another.

A recent report from the Organic Trade Association stated that the U.S. market for organic products was \$52.2 billion and accounted for 5.7% of all food sales in the United States in 2018. They reported that the majority of organic food sales were fruits and vegetables, accounting for $17.4 billion in sales; dairy and eggs made up the second-largest organic food category at \$6.5 billion in sales. Sales of organic fruits and vegetables grew by 5.6% which far surpassed the growth of the overall fruit and vegetable market at 1.7%. Non-food organic products saw 10.6% overall growth from 2017 to 2018 also surpassing the growth of the overall non-food segment at 3.6% (Redman). And recent polling by IRI, a consumer research company, found that 49% of Millennials and 40% of Gen X shoppers consider having a good selection of natural and organic foods important in selecting a grocery store (Emarketer). 

For this project, we are acting as a team of analysts who are interested in identifying households that are likely to buy organic products so we know who to target for an organic product marketing campaign. In order to do this, we will use data at both the household and basket level and try classification models to accurately identify these households. We are also interested in organic trends over time and will use a classification model to attempt to flag households who have increased their spending on organic products in year two. Finally, we will use market basket analysis to mine for association rules to give insight on organic products frequently bought together. 

## The Data

The data set we are using for our project is called "The Complete Journey 2.0" and it is found on the 84.51 website (84.51). This data set has transactions at the household level from a group of 5,000 households over a two year period. This is a relational data set comprised of household data, transaction data, and product data that can be combined by household and product IDs. The household data set has demographic information such as the size, income, and age of the  household.The transaction data set is made up of over 10 billion rows; each row represents one item purchased by a customer and provides an ID for the item purchased, the household who purchased it, a 'Basket' ID which groups items purchased in the same transation, and information like the the date purchased and cost of the item. The product data set links to the transaction data set by the product ID and gives some high level information on each product including the product category, whether a product is organic, and whether the product is a private or national brand. 

A graphical representation of the structure of our data set is displayed in Figure X.
!["The Complete Journey 2.0" Data Structure](images/data_structure.png)

## Major Findings

#Predicting Organic Households
The goal for this part of the analysis is to come up with a classification model that can help predict whether a household will buy organic products. An "organic household" subset of the original data sets was created with the dependent variable being "ORG_HOUSE" (1 if the household has purchased an organic product, 0 if not). This data set contains only complete observations and includes the demographic data from the households data set as well as the amount spent, total units purchased, and unique purcahsed for both organic and non-organic products. This data set has a total of 3,370 observations and 16 variables. 

Looking at the summary of the data, 2,791 households have purchased an organic product (this is about 83% of the data set). Because a household will qualify as an "organic household" even if they've only purchased one organic product, this percentage is very high. To make the model more realistic, this variable has been re-coded to qualify any household that purchases at least 10% of their total project organic. Using this method, only about 9% of the data set is considered an organic household, but these are the households we would most want to identify because the marketing promotions will be the most relevant to them.

```{r re-code ORG_HOUSE}
#re-code organic households as ones that purchase at least 10% of their items organic
organic_households <- products %>%
  select(PRODUCT_NUM, ORGANIC) %>%
  mutate(ORGANIC = str_replace(ORGANIC, "N", "NORG")) %>%
  mutate(ORGANIC = str_replace(ORGANIC, "Y", "ORG")) %>% 
  right_join(transactions, by = "PRODUCT_NUM") %>%
  group_by(HSHD_NUM, ORGANIC) %>%
  summarise(
    TOTAL_SPEND = sum(SPEND),
    TOTAL_UNITS = sum(UNITS),
    UNIQUE_ITEMS = n_distinct(PRODUCT_NUM)) %>% 
  ungroup() %>%
  pivot_wider(names_from = ORGANIC, values_from = c(TOTAL_SPEND, TOTAL_UNITS, UNIQUE_ITEMS), values_fill = list(TOTAL_SPEND = 0, TOTAL_UNITS = 0, UNIQUE_ITEMS = 0)) %>%
  left_join(households, by = "HSHD_NUM") %>%
  mutate(ORG_HOUSE = ifelse((TOTAL_UNITS_ORG/(TOTAL_UNITS_ORG+TOTAL_UNITS_NORG)) > .10, 1, 0)) %>%
  filter(complete.cases(.) == TRUE)

#convert ORG_HOUSE to factor
organic_households$ORG_HOUSE <- as.factor(organic_households$ORG_HOUSE)

#see what percentage of data set is organic
table(organic_households$ORG_HOUSE)
#only about 9%

#delete hshd number variable bc it is a unique id not used in analysis
organic_households <- organic_households[,-1]
```

Through some initial EDA, we can see that households with higher incomes tend to purchase more organic products. It also appears that younger age ranges buy more organic products which makes sense, seeing as how buying organic is a sort of trend among younger generations. 

```{r org household EDA, echo=FALSE}
org.income <- ggplot(organic_households, aes(fill=ORG_HOUSE, y=nrow(organic_households), x=INCOME_RANGE)) + 
    geom_bar(position="fill", stat="identity")

org.age <- ggplot(organic_households, aes(fill=ORG_HOUSE, y=nrow(organic_households), x=AGE_RANGE)) + 
    geom_bar(position="fill", stat="identity")

org.marital <- ggplot(organic_households, aes(fill=ORG_HOUSE, y=nrow(organic_households), x=MARITAL)) + 
    geom_bar(position="fill", stat="identity")

org.kids <- ggplot(organic_households, aes(fill=ORG_HOUSE, y=nrow(organic_households), x=CHILDREN)) + 
    geom_bar(position="fill", stat="identity")


par(mfrow=c(2,2))
org.income
org.age

```

The first method used in trying to classify organic households is logistic regression. The data set was split into 70% training and 30% testing sets and an initial model was run with ORG_HOUSE as the dependent variable and relevant demographic variables as predictors: age range, income range, marital status, homeowner status, household size, and number of children. Income ranges 100-150k and 150k+ are the most significnat variables from this output. The AIC of this initial model is 1384.011 and the BIC is 1493.565. The in-sample and out-of-sample ROC curve can be seen below. The in-sample AUC is 0.6475069 and the out-of-sample AUC is 0.6126708 meaning that this model is doing better than randomly guessing at classifying organic households, but there is still room for improvement. 


```{r logistic regression initial model}

#split data into training and testing sets
set.seed(8817349)
index <- sample(nrow(organic_households),nrow(organic_households)*0.70)
org.train = organic_households[index,]
org.test = organic_households[-index,]

#train logistic regression model using demographic variables
org.glm0<- glm(ORG_HOUSE~AGE_RANGE+MARITAL+INCOME_RANGE+HOMEOWNER+HH_SIZE+CHILDREN, family=binomial(link="logit"), data=org.train)
summary(org.glm0)

#criteria for model fitting
org.glm0$deviance #1346.011
AIC(org.glm0) #1384.011
BIC(org.glm0) #1493.565
```
```{r in sample prediction, include=TRUE}
#prediction
#ROC curve for in sample data
pred.glm0.train <- predict(org.glm0, type="response") 

library(ROCR)
pred <- prediction(pred.glm0.train, org.train$ORG_HOUSE) 
perf <- performance(pred, "tpr", "fpr") 
plot(perf, colorize=TRUE, main="In-Sample ROC") 

#In Sample AUC
unlist(slot(performance(pred, "auc"), "y.values")) 
#0.6475069
```
```{r out of sample prediction, include=TRUE}
#out of sample prediction
pred.glm0.test<- predict(org.glm0, newdata = org.test, type="response") 

#ROC curve
pred <- prediction(pred.glm0.test, org.test$ORG_HOUSE) 
perf <- performance(pred, "tpr", "fpr")
plot(perf, colorize=TRUE, main="Out of Sample ROC")

#Get the AUC
unlist(slot(performance(pred, "auc"), "y.values"))
#0.6126708
```

Backwards selection was used to narrow down the number of variables used in the model. Now there are 7 predictors chosen and all are significant (maritalSingle, income 35-49k, income50-74k, income 75-99k, income 100-150k, income 150k+, and children). The AIC of this reduced model is 1374.652 and the BIC is 1420.78. The in-sample and out-of-sample AUC's are 0.6314394 and 0.6063656 respectively. Although the AUC is slightly lower than the initial model, this model performs similarly while being less complex.

```{r backwards selection, include=TRUE}
#backwards selection w/ AIC
org.glm.back <- step(org.glm0)
summary(org.glm.back) #7 variables chosen, all significant
org.glm.back$deviance #1358.652
AIC(org.glm.back) #1374.652
BIC(org.glm.back) #1420.78


#in sample prediction
#ROC curve in sample
pred.back.train <- predict(org.glm.back, type="response") 

library(ROCR)
pred <- prediction(pred.back.train, org.train$ORG_HOUSE) 
perf <- performance(pred, "tpr", "fpr") 
plot(perf, colorize=TRUE, main="In-Sample ROC") 

#In Sample AUC
unlist(slot(performance(pred, "auc"), "y.values")) 
#0.6314394

#out of sample prediction
pred.back.test<- predict(org.glm.back, newdata = org.test, type="response") 

#ROC curve
pred <- prediction(pred.back.test, org.test$ORG_HOUSE) 
perf <- performance(pred, "tpr", "fpr")
plot(perf, colorize=TRUE, main="Out of Sample ROC")

#Get the AUC
unlist(slot(performance(pred, "auc"), "y.values"))
#0.6063656
```




## Organic Selling Seasonality Analysis

* Seasonality is common influnce factor in marketing. We are interested in detecting When/Where/How to conduct better organic marketing strategy. To that end, we use aggregated "SPEND" of organic selling data to detect possible seasonality patterns.
* From aggregated "SPEND" time series plots, we can see sense some seasonality.
* In order to find out more accurate seasonality insights, we plan to fit KNN/PAC/K-means/Hierarchical Clustering/Seasonal ARIMA models in to our aggregated "SPEND" time series data to help us detect more accurate seasonality patterns and forecast future trend.
* Test 

```{r org_merge, include=FALSE}
# merge data by "HSHD_NUM" and "PRODUCT_NUM"
merge_df <- merge(transactions,products,by="PRODUCT_NUM")
merge_df <- merge(merge_df,households,by="HSHD_NUM")
str(merge_df)
```
```{r org_int,include=FALSE}
# set HSHD_NUM/PRODUCT_NUM /BASKET_NUM to interger variable
merge_df[sapply(merge_df, is.character)] <- lapply(merge_df[sapply(merge_df, is.character)],as.integer)
head(merge_df)
```

```{r yr_split,include=FALSE}
# filter Organic transactions and split by YEAR
organic <- merge_df%>%filter(ORGANIC=="Y")%>%mutate(WEEK_NUM=as.integer(WEEK_NUM),
                                                    HSHD_NUM=as.factor(HSHD_NUM),
                                                    PRODUCT_NUM=as.factor(PRODUCT_NUM),
                                                    BASKET_NUM=as.factor(BASKET_NUM))
organic_2016 <- organic%>%filter(YEAR=="2016")
organic_2017 <- organic%>%filter(YEAR=="2017")
summary(organic)
# check "organic_2016" structure
str(organic_2016)
```
```{r str2016,include=FALSE}
# check range of "organic_2016$WEEK_NUM"
summary(organic_2016$WEEK_NUM)
```
```{r fac2016week,include=FALSE}
# set "organic_2016$WEEK_NUM" as factor
organic_2016$WEEK_NUM <- as.factor(organic_2016$WEEK_NUM)
```
```{r week2017,include=FALSE}
# check range of "organic_2017$WEEK_NUM"
summary(organic_2017$WEEK_NUM)
```
```{r fac_week_2017,include=FALSE}
# set "organic_2017$WEEK_NUM" as factor
organic_2017$WEEK_NUM <- as.factor(organic_2017$WEEK_NUM)

# reset organic_2017$WEEK_NUM level as 1:52
levels(organic_2017$WEEK_NUM) <- seq(1,52,1)
levels(organic_2017$WEEK_NUM)
```
```{r rbind_org, include=FALSE}
# concatenate data
organic_week <- rbind(organic_2016,organic_2017)
summary(organic_week)
```
```{r org_week_spend_region,include=FALSE}
# aggregate SPEND by week & region
org_week_east_spend <- organic%>%filter(REGION=="EAST")%>%group_by(WEEK_NUM)%>%summarise(SPEND_E=sum(SPEND))
org_week_south_spend <- organic%>%filter(REGION=="SOUTH")%>%group_by(WEEK_NUM)%>%summarise(SPEND_S=sum(SPEND))
org_week_west_spend <- organic%>%filter(REGION=="WEST")%>%group_by(WEEK_NUM)%>%summarise(SPEND_W=sum(SPEND))
org_week_central_spend <- organic%>%filter(REGION=="CENTRAL")%>%group_by(WEEK_NUM)%>%summarise(SPEND_C=sum(SPEND))
organic_week_reg_spend <- merge(org_week_east_spend,org_week_south_spend,by="WEEK_NUM")
organic_week_reg_spend <- merge(organic_week_reg_spend,org_week_west_spend,by="WEEK_NUM")
organic_week_reg_spend <- merge(organic_week_reg_spend,org_week_central_spend,by="WEEK_NUM")
organic_week_reg_spend
```
```{r week_reg_org_spend, echo=FALSE}
# plot Organic Weekly Agregate SPEND by REGION
ggplot(organic_week_reg_spend, aes(WEEK_NUM)) + 
  geom_line(aes(y = SPEND_E, colour = "EAST")) + 
  geom_line(aes(y = SPEND_S, colour = "SOUTH"))+
  geom_line(aes(y = SPEND_W, colour = "WEST"))+
  geom_line(aes(y = SPEND_C, colour = "CENTRAL"))+
  theme(legend.position="bottom")+
  ggtitle("Organic Weekly Agregate SPEND by REGION")+
  ylab("Weekly Aggregated SPEND")
```
```{r organic_week_dep_spend, include=FALSE}
# aggregate SPEND by week & DEPARTMENT
org_week_nfood_spend <- organic%>%filter(DEPARTMENT=="NON-FOOD")%>%group_by(WEEK_NUM)%>%summarise(SPEND_NFOOD=sum(SPEND))
org_week_food_spend <- organic%>%filter(DEPARTMENT=="FOOD")%>%group_by(WEEK_NUM)%>%summarise(SPEND_FOOD=sum(SPEND))
org_week_phar_spend <- organic%>%filter(DEPARTMENT=="PHARMA")%>%group_by(WEEK_NUM)%>%summarise(SPEND_PHAR=sum(SPEND))
org_week_phar_spend # PHARMA data is omited due to very limited records
organic_week_dep_spend <- merge(org_week_nfood_spend,org_week_food_spend,by="WEEK_NUM")
#organic_week_dep_spend <- merge(organic_week_dep_spend,org_week_phar_spend,by="WEEK_NUM")
#organic_week_dep_spend <- organic_week_dep_spend%>%arrange(WEEK_NUM)

organic_week_dep_spend
```
```{r plot_organic_week_dep_spend,echo=FALSE}
# plot Organic Weekly Agregate SPEND by DEPARTMENT
# --> construct separate plots for each series
obj1 <- xyplot(SPEND_NFOOD ~ WEEK_NUM, organic_week_dep_spend, main="Organic Weekly Agregate SPEND by DEPARTMENT",type = "l" , lwd=2)
obj2 <- xyplot(SPEND_FOOD ~ WEEK_NUM, organic_week_dep_spend, type = "l", lwd=2)
# --> Make the plot with second y axis AND legend:
doubleYScale(obj1, obj2, text = c("NON-FOOD", "FOOD") , add.ylab2 = TRUE)
```
```{r organic_week_brand_spend,include=FALSE}
# aggregate SPEND by week & BRAND_TY
org_week_pri_spend <- organic%>%filter(BRAND_TY=="PRIVATE" )%>%group_by(WEEK_NUM)%>%summarise(SPEND_PRI=sum(SPEND))
org_week_nat_spend <- organic%>%filter(BRAND_TY=="NATIONAL")%>%group_by(WEEK_NUM)%>%summarise(SPEND_NAT=sum(SPEND))
organic_week_brand_spend <- merge(org_week_pri_spend,org_week_nat_spend,by="WEEK_NUM")
organic_week_brand_spend
```
```{r plot_organic_week_brand_spend,echo=FALSE}
# plot Organic Weekly Agregate SPEND by BRAND_TY
ggplot(organic_week_brand_spend, aes(WEEK_NUM)) + 
  geom_line(aes(y = SPEND_PRI, colour = "PRIVATE")) + 
  geom_line(aes(y = SPEND_NAT, colour = "NATIONAL")) +  
  theme(legend.position="bottom")+
  ggtitle("Organic Weekly Agregate SPEND by BRAND_TY")+
  ylab("Weekly Aggregated SPEND")
```
```{r organic_week_loy_spend,include=FALSE}
# aggregate SPEND by week & Loyaty
org_week_loy_spend <- organic%>%filter(L=="Y" )%>%group_by(WEEK_NUM)%>%summarise(SPEND_LOY=sum(SPEND))
org_week_nloy_spend <- organic%>%filter(L=="N")%>%group_by(WEEK_NUM)%>%summarise(SPEND_NLOY=sum(SPEND))
organic_week_loy_spend <- merge(org_week_loy_spend,org_week_nloy_spend,by="WEEK_NUM")
organic_week_loy_spend
```
```{r plot_organic_week_loy_spend,echo=FALSE}
# plot Organic Weekly Agregate SPEND by LOYAL
library(latticeExtra)
# --> construct separate plots for each series
obj1 <- xyplot(SPEND_NLOY ~ WEEK_NUM, organic_week_loy_spend, main="Organic Weekly Agregate SPEND by LOYAL",type = "l" , lwd=2)
obj2 <- xyplot(SPEND_LOY ~ WEEK_NUM, organic_week_loy_spend, type = "l", lwd=2)
# --> Make the plot with second y axis AND legend:
doubleYScale(obj1, obj2, text = c("NON-LOYAL", "LOYAL") , add.ylab2 = TRUE)
```
```{r organic_week_spend,include=FALSE}
# merge weekly SPEND data
organic_week_spend <- merge(organic_week_reg_spend,organic_week_dep_spend)
organic_week_spend <- merge(organic_week_spend,organic_week_brand_spend)
organic_week_spend <- merge(organic_week_spend,organic_week_loy_spend)
organic_week_spend <- organic_week_spend%>%mutate(WEEK_NUM=as.factor(WEEK_NUM))
organic_week_spend
```
## Market Basket Analysis 

In order to mine the transaction data for insights into what kinds of organic products our customers purchase together, we performed market basket analysis using the Apriori algorithm. 

The top 10 organic product categories are given in the table below.
```{r message=FALSE, echo=FALSE}
df <- as.data.frame(as.list(colSums(market_basket[ , 2:64])))
select(df, -contains("NON.ORGANIC")) %>%
  pivot_longer(1:21, names_to = "Product", values_to = "Baskets") %>% 
  arrange(desc(Baskets)) %>% 
  top_n(10) %>%
  mutate(Product = str_replace_all(Product, "\\.", " ")) %>%
  kable() %>%
  kable_styling
```

```{r market_basket_matrix, include=FALSE}
#subset market_basket to only look at baskets with at least 1 organic item
organic_market_basket <- market_basket %>%
  filter_at(vars(starts_with("ORGANIC")), any_vars(. == 1))

baskets <- as(as.matrix(organic_market_basket[, -1]), "transactions")
summary(baskets)
```
```{r}
itemFrequencyPlot(baskets, support = 0.1, cex.names = 0.6)
```
```{r}
basket_rules <- apriori(baskets, parameter = list(sup = 0.01, conf = 0.8, target = "rules", maxlen = 3))
```
```{r}
summary(basket_rules)
```
```{r}
organic_names <- colnames(select(organic_market_basket, starts_with("ORGANIC")))
organic_lhs <- subset(basket_rules, subset = lhs %in% organic_names & lift > 1.2)

inspect(organic_lhs)
```
```{r}
organic_only <- market_basket %>%
  filter_at(vars(starts_with("ORGANIC")), any_vars(. == 1)) %>%
  select(starts_with("ORGANIC"))

organic_baskets <- as(as.matrix(organic_only[, -1]), "transactions")
itemFrequencyPlot(organic_baskets, support = 0.01, cex.names = 0.7)
```
```{r}
organic_basket_rules <- apriori(organic_baskets, parameter = list(sup = 0.001, conf = 0.6, target = "rules", maxlen = 5))
summary(organic_basket_rules)
```
```{r}
inspect(subset(organic_basket_rules, subset = lift > 2.8))
```


# Works Cited

84.51. "The Complete Journey 2.0" Area 51 Source Files. https://www.8451.com/area51

Redman, Russell. "Organic Products Hit a Record-Breaking High." Supermarket News (May 20, 2019). https://search-proquest-com.proxy.libraries.uc.edu/docview/2238503079?accountid=2909.)

Emarketer. "Consumer Connect Q4 2019: Channel Trends in CPG Today." https://chart-na1.emarketer.com/234160/attributes-us-internet-users-find-important-store-selection-process-by-generation-dec-2019-of-respondents-each-group