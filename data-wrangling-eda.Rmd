---
title: "Data Wrangling & EDA"
output:
  html_document:
    df_print: paged
  html_notebook: default
  word_document: default
---
```{r libraries, warning=FALSE, include= FALSE}
#load needed libraries
library(tidyverse)
library(lubridate)
library(gridExtra) 
library(modeest)
library(knitr)
library(kableExtra)
library(latticeExtra)
```
```{r set_wd_load_data, include=FALSE, warning=FALSE, message=FALSE}
#Setting wd and loading data
#put the path of where you are storing the data on your computer
paths = c('C:/Users/eliza/Documents/BANA 7047 - Data Mining II/Group Project/Data', 'C:/Users/ashle/Downloads/8451_The_Complete_Journey_2_Master (1)/The_Complete_Journey_2_Master', 'C:/Users/xiaoj/Desktop/BANA/BANA7047 Data Mining II/Project/8451_The_Complete_Journey_2_Master/The_Complete_Journey_2_Master')
#use the code Sys.info()[7] to find out how your name is stored on your local machine, copy to this list
names(paths) = c('eliza', 'ashle', 'xiaoj')
#this will set the wd
setwd(paths[Sys.info()[7]])

#load data sets
households <- read_csv('5000_households.csv', col_types = cols(.default = 'f', HSHD_NUM = 'c'), na = c("null", "", "NA", "NOT AVAILABLE", "Unknown"))
transactions <- read_csv('5000_transactions.csv', col_types = cols(.default = '?', STORE_R = 'f', YEAR = 'f'), na = c("null", "", "NA"))
products <- read_csv('5000_products.csv', col_types = cols(.default = 'f', PRODUCT_NUM = 'c'), na = c("null", "", "NA"))

#rename column 'X5' to be more descriptive
products <- products %>% rename(ORGANIC = X5)

#rename truncated date and store region column on transactions
transactions <- transactions %>%
  rename(DATE = PURCHASE_) %>%
  rename(REGION = STORE_R)

#make 'DATE' column in transactions dataset into a date format
transactions <- transactions %>%
  mutate(DATE = dmy(DATE))

#reorder factors on households dataset
households <- households %>%
  mutate(AGE_RANGE = fct_relevel(AGE_RANGE,
                                  "19-24",
                                  "25-34",
                                  "35-44",
                                  "45-54",
                                  "55-64",
                                  "65-74",
                                  "75+")) %>%
  mutate(INCOME_RANGE = fct_relevel(INCOME_RANGE,
                                    "UNDER 35K",
                                    "35-49K",
                                    "50-74K",
                                    "75-99K",
                                    "100-150K",
                                    "150K+")) %>%
  mutate(HH_SIZE = fct_relevel(HH_SIZE,
                               "1",
                               "2",
                               "3",
                               "4",
                               "5+")) %>%
  mutate(CHILDREN = fct_relevel(CHILDREN,
                                "1",
                                "2",
                                "3"))

#By default the households dataset encodes all households without children as having a 'CHILDREN' value of NA. This encodes these households with a CHILDREN value of 0 to avoid missing values.
households <- households %>%
  mutate(CHILDREN = ifelse(HSHD_COMPOSITION %in% c("1 Adult", "2 Adults", "Single Male", "Single Female"), 0, CHILDREN))

#There are some transactions with negative spends and negative units or units of 0, assuming that the negative spends and negative units are returns, unsure of the transactions with 0 units, but we are filtering these from the transactions table
returns <- transactions %>% 
  filter(UNITS < 1) #I am assuming the items with negative spends and positive units are items bought with a coupon that reduced the price below 0

transactions <- anti_join(transactions, returns, by = c("BASKET_NUM", "PRODUCT_NUM"))
```
```{r hh_plots, include=FALSE}
#Since we are only working with complete cases for prediction, I re-did these graphs to show only complete cases

income <- households %>%
  filter(complete.cases(.) == TRUE) %>%
  mutate(INCOME_RANGE = fct_recode(INCOME_RANGE, "<35K" = "UNDER 35K")) %>%
  ggplot() +
    geom_bar(mapping = aes(x = INCOME_RANGE)) +
    labs(x = "", y = "", title = "Household Income")

age <- households %>%
  filter(complete.cases(.) == TRUE) %>%
  ggplot() +
    geom_bar(mapping = aes(x = AGE_RANGE)) +
    labs(x = "", y = "", title = "Primary Shopper Age")

size <- households %>%
  filter(complete.cases(.) == TRUE) %>%
  ggplot() +
    geom_bar(mapping = aes(x = HH_SIZE)) +
    labs(x = "", y = "", title = "Size of Household")

comp <- households %>%
  filter(complete.cases(.) == TRUE) %>%
  ggplot() +
    geom_bar(mapping = aes(x = HSHD_COMPOSITION)) +
    labs(x = "", y = "", title = "Household Composition")

children <- households %>%
  filter(complete.cases(.) == TRUE) %>%
  ggplot() +
    geom_bar(mapping = aes(x = CHILDREN)) +
    labs(x = "", y = "", title = "Number of Children")

homeowner <- households %>%
  filter(complete.cases(.) == TRUE) %>%
  ggplot() +
    geom_bar(mapping = aes(x = HOMEOWNER)) +
    labs(x = "", y = "", title = "Homeowner Status") +
    coord_flip()

loyalty <- households %>%
  filter(complete.cases(.) == TRUE) %>%
  ggplot() +
    geom_bar(mapping = aes(x = L)) +
    labs(x = "", y = "", title = "Loyalty Card Status") +
    coord_flip()

marital <- households %>%
  filter(complete.cases(.) == TRUE) %>%
  ggplot() +
    geom_bar(mapping = aes(x = MARITAL)) +
    labs(x = "", y = "", title = "Marital Status") +
    coord_flip()
```
# Background Information and Objective

Understanding what drives customers to buy organic products is key as in many segments the market growth of organic products is outstripping that of the overall segment. Organic products also represent billions of dollars in sales and the availability of orgnic products is a key factor in why some consumers pick one grocery store over another.

A recent report from the Organic Trade Association stated that the U.S. market for organic products was \$52.2 billion and accounted for 5.7% of all food sales in the United States in 2018. They reported that the majority of organic food sales were fruits and vegetables, accounting for $17.4 billion in sales; dairy and eggs made up the second-largest organic food category at \$6.5 billion in sales. Sales of organic fruits and vegetables grew by 5.6% which far surpassed the growth of the overall fruit and vegetable market at 1.7%. Non-food organic products saw 10.6% overall growth from 2017 to 2018 also surpassing the growth of the overall non-food segment at 3.6% (Redman). And recent polling by IRI, a consumer research company, found that 49% of Millennials and 40% of Gen X shoppers consider having a good selection of natural and organic foods important in selecting a grocery store (Emarketer). 

For this project, we are acting as a team of analysts that is interested in identifying households and baskets that are likely to buy organic products so we know who to target for an organic product marketing campaign. In order to do this, we will use data at both the household and basket level and try classification models to accurately identify these households. We are also interested in organic trends over time and will use a classification model to attempt to flag households who have increased their spending on organic products in year two.

# The Data

The data set we are using for our project is called "The Complete Journey 2.0" and it is found on the 84.51 website. This data set has transactions at the household level from a group of 5,000 households over a two year period. This is a relational data set comprised of household data, transaction data, and product data that can be combined by household and product IDs. The household data has demographic information such as the size, income, and age of the household. The transaction data contains information like the amount of money spent and the number of items in a transaction. The product data contains information like the product category, whether a product is organic, and whether the product is a private or national brand. 

## Household Data Set

The households data set has 5000 observations, one for each household with a unique key for each household and 8 variables which give demographic data. The column 'HSHD_NUM' is a unique key that links this data set to the transactions data set. Demographic variables include age range, marital status, income range, number of children, household composition, household size, homeowner status, and whether the household has a store loyality card. Every household has a 'HSHD_NUM' key and information on if that household has a loyality card. Complete demographic data is available for  `r sum(complete.cases(households))` and partial demographic data is available for `r sum(rowSums(is.na(households[3:9]))<7 & rowSums(is.na(households[3:9]))>0)` households.

The majority of households fall between the ages of 35 and 74 and the distribution of age appears to be fairly normal with the exception of the very low number of households in the 19-24 range. This could be due to the fact that many younger shoppers still use their parent's loyalty card, so their data could show up under their parent's age. The vast majority of households are owners as opposed to renters and the majority of households also have a loyalty card. Income is slightly skewed right with fewer households making above $75,000. Many households in the data set are also comprised of only two adults, or two adults with one child. 

```{r hh_grid_plot1, echo=FALSE, fig.height=3, fig.width=8}
grid.arrange(size, age, ncol = 2)
```
```{r hh_grid_plot2, echo=FALSE, fig.height=3, fig.width=8}
grid.arrange(income, homeowner, ncol = 2)
```
```{r hh_grid_plot3, echo=FALSE, fig.height=3, fig.width=8}
grid.arrange(marital, children, ncol = 2)
```
```{r hh_loyalty_plot, echo=FALSE, fig.height=3, fig.width=5}
loyalty
```
```{r hh_comp_plot, echo=FALSE, fig.height=4, fig.width=8}
comp
```

## Products Data Set
The products data set has 151,141 observations and 5 variables which give information about the product. Each product has a unique 'PRODUCT_NUM' that links it to the transaction data set. Information such as the product department (food, non-food, or pharmacy), whether the product is a private or national brand, whether the product is organic, and the commodity of the product can be found in this data set. Product commidity is the most detailed information given about a given product so while we cannot pinpoint specific brands in this data set, we can see which categories of products are being bought organic. 

## Transactions Data Set
The transactions data set has 10,625,553 observations and 9 variables which give detailed information about every transaction over a two year period. Both the households and products data sets can be linked to the transaction set by the 'HSHD_NUM' and 'PRODUCT_NUM' keys. Information such as the date of purchase, the amount spent and number of units purchased, and store region can be found in this data set. 

Through data exploration, we found that 6,427 transactions had negative spend and a negative unit or unit of 0. We are assuming that these records account for returns, so we chose to filter them out of the data set for the rest of our analysis. There are some transactions with negative spend but a postive unit count, we are assuming these transactions represent a customer reducing the price of an item through couponing or other discounts. The transaction data set now contains 10,619,064 records. 
```{r baskets, include=FALSE}
#creating a data set with basket level detail - filter out returns
mode <- function(x){
  which.max(tabulate(x))
}

baskets <- transactions %>%
  mutate(YEAR = as.numeric(YEAR)) %>%
  mutate(DATE = as.numeric(DATE)) %>%
  group_by(HSHD_NUM, BASKET_NUM) %>%
  summarise(
    PRODUCTS = n(),
    TOTAL_SPEND = sum(SPEND),
    TOTAL_UNITS = sum(UNITS),
    DATE = mode(DATE), #baskets can have multiple dates but they all appear to only differ by one day, suggesting these are purchases taking place around midnight - the first item scanned may have been at 11:58 pm the previous day and the last item scanned at 12:01 am the current day - this is an assumption as time of scan is not available. This function takes the mode as the actual date
    YEAR = mode(YEAR)
  ) %>%
  mutate(YEAR = ifelse(YEAR == 1, "2016", "2017")) %>%
  mutate(DATE = as_date(DATE, origin = lubridate::origin))

summary(baskets)
```
```{r key_check, include=FALSE}
#confirming primary keys in each table are unique
households %>% 
  count(HSHD_NUM) %>% 
  filter(n > 1)

products %>%
  count(PRODUCT_NUM) %>% 
  filter(n > 1)

baskets %>%
  count(BASKET_NUM) %>% 
  filter(n > 1)
```
```{r market_basket, include=FALSE}
market_basket <- products %>%
  mutate(ORGANIC = str_replace(ORGANIC, "N", "NON-ORGANIC")) %>%
  mutate(ORGANIC = str_replace(ORGANIC, "Y", "ORGANIC")) %>% 
  mutate(PRODUCT_NAME = str_c(ORGANIC, COMMODITY, sep = " ")) %>%
  select(PRODUCT_NUM, PRODUCT_NAME) %>%
  mutate(INDICATOR = 1) %>%
  right_join(transactions, by = "PRODUCT_NUM") %>%
  select(BASKET_NUM, PRODUCT_NAME, INDICATOR) %>%
  distinct() %>%
  pivot_wider(names_from = PRODUCT_NAME, 
              values_from = INDICATOR, 
              values_fill = list(INDICATOR = 0))

```
```{r organic_households, include=FALSE}
organic_households <- products %>%
  select(PRODUCT_NUM, ORGANIC) %>%
  mutate(ORGANIC = str_replace(ORGANIC, "N", "NORG")) %>%
  mutate(ORGANIC = str_replace(ORGANIC, "Y", "ORG")) %>% 
  right_join(transactions, by = "PRODUCT_NUM") %>%
  group_by(HSHD_NUM, ORGANIC) %>%
  summarise(
    TOTAL_SPEND = sum(SPEND),
    TOTAL_UNITS = sum(UNITS),
    UNIQUE_ITEMS = n_distinct(PRODUCT_NUM)) %>% 
  ungroup() %>%
  pivot_wider(names_from = ORGANIC, values_from = c(TOTAL_SPEND, TOTAL_UNITS, UNIQUE_ITEMS), values_fill = list(TOTAL_SPEND = 0, TOTAL_UNITS = 0, UNIQUE_ITEMS = 0)) %>%
  left_join(households, by = "HSHD_NUM") %>%
  mutate(ORG_HOUSE = ifelse(TOTAL_UNITS_ORG > 0, 1, 0)) %>%
  filter(complete.cases(.) == TRUE)
```
```{r household_increase, include=FALSE}
#first we will take the baskets dataset & compute the average spend per basket per year and the average cost per item per year

basket_by_year <- baskets %>%
  mutate(COST_PER_UNIT = TOTAL_SPEND / TOTAL_UNITS) %>%
  group_by(HSHD_NUM, YEAR) %>% 
  summarise(
    AVG_SPEND = mean(TOTAL_SPEND),
    AVG_UNITS = mean(TOTAL_UNITS),
    AVG_COST_PER_UNIT = mean(COST_PER_UNIT)
  ) %>%
  pivot_wider(names_from = c(YEAR), values_from = c(AVG_SPEND, AVG_UNITS, AVG_COST_PER_UNIT), values_fill = list(AVG_SPEND = 0, AVG_UNITS = 0, AVG_COST_PER_UNIT = 0))

household_increase <- products %>%
  select(PRODUCT_NUM, ORGANIC) %>%
  mutate(ORGANIC = str_replace(ORGANIC, "N", "NORG")) %>%
  mutate(ORGANIC = str_replace(ORGANIC, "Y", "ORG")) %>% 
  right_join(transactions, by = "PRODUCT_NUM") %>%
  group_by(HSHD_NUM, ORGANIC, YEAR) %>%
  summarise(
    TRIPS = n(),
    TOTAL_SPEND = sum(SPEND),
    TOTAL_UNITS = sum(UNITS),
    UNIQUE_ITEMS = n_distinct(PRODUCT_NUM)) %>% 
  ungroup() %>%
  pivot_wider(names_from = c(ORGANIC, YEAR), values_from = c(TRIPS, TOTAL_SPEND, TOTAL_UNITS, UNIQUE_ITEMS), values_fill = list(TRIPS = 0, TOTAL_SPEND = 0, TOTAL_UNITS = 0, UNIQUE_ITEMS = 0)) %>%
  left_join(households, by = "HSHD_NUM") %>%
  mutate(ORG_INCREASE = ifelse(TOTAL_SPEND_ORG_2016 < TOTAL_SPEND_ORG_2017, 1, 0)) %>%
  filter(complete.cases(.) == TRUE) %>%
  filter(TOTAL_SPEND_ORG_2016 > 0) %>%
  mutate(PERCENT_ORG_CHANGE = (TOTAL_SPEND_ORG_2017 - TOTAL_SPEND_ORG_2016) / TOTAL_SPEND_ORG_2016) %>%
  left_join(basket_by_year, by = "HSHD_NUM")

```

```{r include=FALSE, warning=FALSE}
#save out created datasets to work with in future

setwd(paths[Sys.info()[7]])
save(market_basket, file = "market_basket.Rdata", compress = FALSE)
save(organic_households, file = "organic_households.Rdata", compress = FALSE)
save(household_increase, file = "household_increase.Rdata", compress = FALSE)

#should be able to use function "load(file = "organic_households.Rdata")" to load dataset when you need it in a different notebook
```
## Proposed Work for the Rest of the Project

#Predicting Organic Households
The goal for this part of the analysis is to come up with a classification model that can help predict whether a household will buy organic products. For the remainder of the semester, logistic regression and classification tree models will be used to try and achieve this goal. An "organic household" subset of the original data sets was created with the dependent variable being "ORG_HOUSE" (1 if the household has purchased an organic product, 0 if not). This data set contains only complete observations and includes the demographic data from the households data set as well as the amount spent, total units purchased, and unique purcahsed for both organic and non-organic products. This data set has a total of 3,370 observations and 16 variables. 

Looking at the summary of the data, 2,791 households have purchased an organic product (this is about 83% of the data set). Because a household will qualify as an "organic household" even if they've only purchased one organic product, this percentage is very high. After defining an initial model, we may introduce a different threshold for a household to be able to qualify as "organic." Some preliminary ideas are if a household purchases 25% or 50% more units of organic goods than non-organic goods, or if a household spends a certain amount of money on organic products. 

```{r org household summary, echo=FALSE}
summary(organic_households)
```

Through some preliminary data exploration, we see that both organic and non-organic households appear to be somewhat normally distributed by age ranges. There doesn't appear to be a clear demographic factor that organic households share, so this is something we will try to narrow down in our future analysis. 

```{r org household age, echo=FALSE}

counts<- table(organic_households$ORG_HOUSE, organic_households$AGE_RANGE)
counts2<- table(organic_households$ORG_HOUSE, organic_households$INCOME_RANGE)
counts3<- table(organic_households$ORG_HOUSE, organic_households$MARITAL)
counts4<- table(organic_households$ORG_HOUSE, organic_households$HH_SIZE)


org_age <- barplot(counts, main="Organic Households by Age Range",
        xlab="Age Range", col=c("lightblue","lightgreen"),
        legend = c("Not Organic", "Organic"), beside=TRUE)

org_income <- barplot(counts2, main="Organic Households by Income Range",
        xlab="Income Range", col=c("lightblue","lightgreen"),
        legend = c("Not Organic", "Organic"), beside=FALSE)

org_marital <- barplot(counts3, main="Organic Households by Marital Status",
                      xlab="Marital Status", col=c("lightblue","lightgreen"),
                      legend = c("Not Organic", "Organic"), beside=FALSE)

org_size <- barplot(counts4, main="Organic Households by HH Size",
                      xlab="HH Size", col=c("lightblue","lightgreen"),
                      legend = c("Not Organic", "Organic"), beside=FALSE)

par(mfrow=c(2,2))
org_age
org_income
org_marital
org_size

```

Additionally, when plotting the nonorganic spend with the nonorganic number of units purchased, there is a somewhat linear relationship, which is to be expected, but non-organic households (blue) tend to purchase fewer units and spend less on non-organic products than orgnaic households. Zooming in on this chart reveals that many non-organic households are clustered between $100 spend and 200 units. This means that organic households are not only purchasing organic products, but they are also purchasing more expensive and higher quantities of non-organic quantities than the non-organic households. 

```{r nonorganic spend and units purchased, echo=FALSE}
par(mfrow=c(1,2))

org_spend1 <- plot(organic_households$TOTAL_UNITS_NORG~organic_households$TOTAL_SPEND_NORG, xlab="Total Units Non-Organic", ylab="Total Spend Non-Organic", xlim=c(0,50000), ylim=c(0,20000), main="NonOrganic Units vs Spend", pch=2, cex.main=1.5, frame.plot=FALSE, col=ifelse(organic_households$ORG_HOUSE==1,"red","blue"))
legend(80, 15000, pch=c(2,2), col=c("red", "blue"), c("Organic", "NonOrganic"), bty="o",  box.col="darkgreen", cex=.8)

org_spend2 <- plot(organic_households$TOTAL_UNITS_NORG~organic_households$TOTAL_SPEND_NORG, xlab="Total Units Non-Organic", ylab="Total Spend Non-Organic", xlim=c(0,1000), ylim=c(0,400), main="NonOrganic Units vs Spend", pch=2, cex.main=1.5, frame.plot=FALSE, col=ifelse(organic_households$ORG_HOUSE==1,"red","blue"))
legend(80, 350, pch=c(2,2), col=c("red", "blue"), c("Organic", "NonOrganic"), bty="o",  box.col="darkgreen", cex=.8)

```

## Organic Selling Seasonality Analysis

* Seasonality is common influnce factor in marketing. We are interested in detecting When/Where/How to conduct better organic marketing strategy. To that end, we use aggregated "SPEND" of organic selling data to detect possible seasonality patterns.
* From aggregated "SPEND" time series plots, we can see sense some seasonality.
* In order to find out more accurate seasonality insights, we plan to fit KNN/PAC/K-means/Hierarchical Clustering/Seasonal ARIMA models in to our aggregated "SPEND" time series data to help us detect more accurate seasonality patterns and forecast future trend.

```{r org_merge, include=FALSE}
# merge data by "HSHD_NUM" and "PRODUCT_NUM"
merge_df <- merge(transactions,products,by="PRODUCT_NUM")
merge_df <- merge(merge_df,households,by="HSHD_NUM")
str(merge_df)
```
```{r org_int,include=FALSE}
# set HSHD_NUM/PRODUCT_NUM /BASKET_NUM to interger variable
merge_df[sapply(merge_df, is.character)] <- lapply(merge_df[sapply(merge_df, is.character)],as.integer)
head(merge_df)
```

```{r yr_split,include=FALSE}
# filter Organic transactions and split by YEAR
organic <- merge_df%>%filter(ORGANIC=="Y")%>%mutate(WEEK_NUM=as.integer(WEEK_NUM),
                                                    HSHD_NUM=as.factor(HSHD_NUM),
                                                    PRODUCT_NUM=as.factor(PRODUCT_NUM),
                                                    BASKET_NUM=as.factor(BASKET_NUM))
organic_2016 <- organic%>%filter(YEAR=="2016")
organic_2017 <- organic%>%filter(YEAR=="2017")
summary(organic)
# check "organic_2016" structure
str(organic_2016)
```
```{r str2016,include=FALSE}
# check range of "organic_2016$WEEK_NUM"
summary(organic_2016$WEEK_NUM)
```
```{r fac2016week,include=FALSE}
# set "organic_2016$WEEK_NUM" as factor
organic_2016$WEEK_NUM <- as.factor(organic_2016$WEEK_NUM)
```
```{r week2017,include=FALSE}
# check range of "organic_2017$WEEK_NUM"
summary(organic_2017$WEEK_NUM)
```
```{r fac_week_2017,include=FALSE}
# set "organic_2017$WEEK_NUM" as factor
organic_2017$WEEK_NUM <- as.factor(organic_2017$WEEK_NUM)

# reset organic_2017$WEEK_NUM level as 1:52
levels(organic_2017$WEEK_NUM) <- seq(1,52,1)
levels(organic_2017$WEEK_NUM)
```
```{r rbind_org, include=FALSE}
# concatenate data
organic_week <- rbind(organic_2016,organic_2017)
summary(organic_week)
```
```{r org_week_spend_region,include=FALSE}
# aggregate SPEND by week & region
org_week_east_spend <- organic%>%filter(REGION=="EAST")%>%group_by(WEEK_NUM)%>%summarise(SPEND_E=sum(SPEND))
org_week_south_spend <- organic%>%filter(REGION=="SOUTH")%>%group_by(WEEK_NUM)%>%summarise(SPEND_S=sum(SPEND))
org_week_west_spend <- organic%>%filter(REGION=="WEST")%>%group_by(WEEK_NUM)%>%summarise(SPEND_W=sum(SPEND))
org_week_central_spend <- organic%>%filter(REGION=="CENTRAL")%>%group_by(WEEK_NUM)%>%summarise(SPEND_C=sum(SPEND))
organic_week_reg_spend <- merge(org_week_east_spend,org_week_south_spend,by="WEEK_NUM")
organic_week_reg_spend <- merge(organic_week_reg_spend,org_week_west_spend,by="WEEK_NUM")
organic_week_reg_spend <- merge(organic_week_reg_spend,org_week_central_spend,by="WEEK_NUM")
organic_week_reg_spend
```
```{r week_reg_org_spend, echo=FALSE}
# plot Organic Weekly Agregate SPEND by REGION
ggplot(organic_week_reg_spend, aes(WEEK_NUM)) + 
  geom_line(aes(y = SPEND_E, colour = "EAST")) + 
  geom_line(aes(y = SPEND_S, colour = "SOUTH"))+
  geom_line(aes(y = SPEND_W, colour = "WEST"))+
  geom_line(aes(y = SPEND_C, colour = "CENTRAL"))+
  theme(legend.position="bottom")+
  ggtitle("Organic Weekly Agregate SPEND by REGION")+
  ylab("Weekly Aggregated SPEND")
```
```{r organic_week_dep_spend, include=FALSE}
# aggregate SPEND by week & DEPARTMENT
org_week_nfood_spend <- organic%>%filter(DEPARTMENT=="NON-FOOD")%>%group_by(WEEK_NUM)%>%summarise(SPEND_NFOOD=sum(SPEND))
org_week_food_spend <- organic%>%filter(DEPARTMENT=="FOOD")%>%group_by(WEEK_NUM)%>%summarise(SPEND_FOOD=sum(SPEND))
org_week_phar_spend <- organic%>%filter(DEPARTMENT=="PHARMA")%>%group_by(WEEK_NUM)%>%summarise(SPEND_PHAR=sum(SPEND))
org_week_phar_spend # PHARMA data is omited due to very limited records
organic_week_dep_spend <- merge(org_week_nfood_spend,org_week_food_spend,by="WEEK_NUM")
#organic_week_dep_spend <- merge(organic_week_dep_spend,org_week_phar_spend,by="WEEK_NUM")
#organic_week_dep_spend <- organic_week_dep_spend%>%arrange(WEEK_NUM)

organic_week_dep_spend
```
```{r plot_organic_week_dep_spend,echo=FALSE}
# plot Organic Weekly Agregate SPEND by DEPARTMENT
# --> construct separate plots for each series
obj1 <- xyplot(SPEND_NFOOD ~ WEEK_NUM, organic_week_dep_spend, main="Organic Weekly Agregate SPEND by DEPARTMENT",type = "l" , lwd=2)
obj2 <- xyplot(SPEND_FOOD ~ WEEK_NUM, organic_week_dep_spend, type = "l", lwd=2)
# --> Make the plot with second y axis AND legend:
doubleYScale(obj1, obj2, text = c("NON-FOOD", "FOOD") , add.ylab2 = TRUE)
```
```{r organic_week_brand_spend,include=FALSE}
# aggregate SPEND by week & BRAND_TY
org_week_pri_spend <- organic%>%filter(BRAND_TY=="PRIVATE" )%>%group_by(WEEK_NUM)%>%summarise(SPEND_PRI=sum(SPEND))
org_week_nat_spend <- organic%>%filter(BRAND_TY=="NATIONAL")%>%group_by(WEEK_NUM)%>%summarise(SPEND_NAT=sum(SPEND))
organic_week_brand_spend <- merge(org_week_pri_spend,org_week_nat_spend,by="WEEK_NUM")
organic_week_brand_spend
```
```{r plot_organic_week_brand_spend,echo=FALSE}
# plot Organic Weekly Agregate SPEND by BRAND_TY
ggplot(organic_week_brand_spend, aes(WEEK_NUM)) + 
  geom_line(aes(y = SPEND_PRI, colour = "PRIVATE")) + 
  geom_line(aes(y = SPEND_NAT, colour = "NATIONAL")) +  
  theme(legend.position="bottom")+
  ggtitle("Organic Weekly Agregate SPEND by BRAND_TY")+
  ylab("Weekly Aggregated SPEND")
```
```{r organic_week_loy_spend,include=FALSE}
# aggregate SPEND by week & Loyaty
org_week_loy_spend <- organic%>%filter(L=="Y" )%>%group_by(WEEK_NUM)%>%summarise(SPEND_LOY=sum(SPEND))
org_week_nloy_spend <- organic%>%filter(L=="N")%>%group_by(WEEK_NUM)%>%summarise(SPEND_NLOY=sum(SPEND))
organic_week_loy_spend <- merge(org_week_loy_spend,org_week_nloy_spend,by="WEEK_NUM")
organic_week_loy_spend
```
```{r plot_organic_week_loy_spend,echo=FALSE}
# plot Organic Weekly Agregate SPEND by LOYAL
library(latticeExtra)
# --> construct separate plots for each series
obj1 <- xyplot(SPEND_NLOY ~ WEEK_NUM, organic_week_loy_spend, main="Organic Weekly Agregate SPEND by LOYAL",type = "l" , lwd=2)
obj2 <- xyplot(SPEND_LOY ~ WEEK_NUM, organic_week_loy_spend, type = "l", lwd=2)
# --> Make the plot with second y axis AND legend:
doubleYScale(obj1, obj2, text = c("NON-LOYAL", "LOYAL") , add.ylab2 = TRUE)
```
```{r organic_week_spend,include=FALSE}
# merge weekly SPEND data
organic_week_spend <- merge(organic_week_reg_spend,organic_week_dep_spend)
organic_week_spend <- merge(organic_week_spend,organic_week_brand_spend)
organic_week_spend <- merge(organic_week_spend,organic_week_loy_spend)
organic_week_spend <- organic_week_spend%>%mutate(WEEK_NUM=as.factor(WEEK_NUM))
organic_week_spend
```
## Market Basket Analysis 

In order to mine the transactions data for insights into what kind of organic products our customers purchase together, we will perform market basket analysis using the Apriori algorithm. Using data from both the transactions dataset and product dataset we have created a sparse matrix where rows represent a basket of products and the columns represent the types of items purchased. 

The top 10 organic product categories are given in the table below.
```{r message=FALSE, echo=FALSE}
df <- as.data.frame(as.list(colSums(market_basket[ , 2:64])))
select(df, -contains("NON.ORGANIC")) %>%
  pivot_longer(1:21, names_to = "Product", values_to = "Baskets") %>% 
  arrange(desc(Baskets)) %>% 
  top_n(10) %>%
  mutate(Product = str_replace_all(Product, "\\.", " ")) %>%
  kable() %>%
  kable_styling
```
# Works Cited

Redman, Russell. "Organic Products Hit a Record-Breaking High." Supermarket News (May 20, 2019). https://search-proquest-com.proxy.libraries.uc.edu/docview/2238503079?accountid=2909.)

Emarketer. "Consumer Connect Q4 2019: Channel Trends in CPG Today." https://chart-na1.emarketer.com/234160/attributes-us-internet-users-find-important-store-selection-process-by-generation-dec-2019-of-respondents-each-group